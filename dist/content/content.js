var itemsDict={},lastCursorDict={};+localStorage.getItem("timeout")||localStorage.setItem("timeout",1e3);var tiktokParse=()=>{const e=document.querySelector('meta[property="twitter:creator:id"]');if(!e)return;const t=e.content,a=document.querySelectorAll(".video-feed-item-wrapper").length,o=document.querySelectorAll(".video-feed-item-wrapper.marked").length;let r;if(lastCursorDict[t]||itemsDict[t]&&a<=o)return void updateProfile(t);if(itemsDict[t]&&itemsDict[t].length){const e=itemsDict[t].reduce(((e,t)=>e<t.createTime?e:t.createTime));r=1e3*e}else r=1e3*(new Date).getTime(),itemsDict[t]=[];const d=document.querySelector('meta[property="al:ios:url"]').content,i=new URL(`https://tiktok.com/${d.replace("snssdk1233://","")}`),n=i.pathname.split("/")[i.pathname.split("/").length-1];let s=new XMLHttpRequest;s.open("GET",`https://m.tiktok.com/api/item_list/?count=30&id=${n}&maxCursor=${r}&minCursor=0&sourceType=8`),s.responseType="json",s.onload=async()=>{localStorage.setItem("timeout",1e3);let e=s.response;if(e.hasMore||(lastCursorDict[t]=r),!e.items&&itemsDict[t]&&itemsDict[t].length){for(let e=0;e<itemsDict[t].length;e++){const a=itemsDict[t][e],o=document.querySelector(`a[href^="https://www.tiktok.com/@${t}/video/${a.id}"]`);o&&addItem(a,o)}document.querySelectorAll(`a[href^="https://www.tiktok.com/@${t}/video/"]`).forEach((e=>e.classList.add("marked"))),await getItem("Video:Sort by ER")?sortByER():sortByCreationTime(t)}else{itemsDict[t].push(...e.items);const a=document.querySelector(".share-layout-header.share-header"),o=document.createElement("h2");a.insertBefore(o,document.querySelector(".share-desc")),o.classList.add("count-infos"),o.classList.add("tt-analytic-1");const r=document.createElement("h2");a.insertBefore(r,document.querySelector(".share-desc")),r.classList.add("count-infos"),r.classList.add("tt-analytic-2"),updateProfile(t);for(let a=0;a<e.items.length;a++){const o=e.items[a],r=document.querySelector(`a[href^="https://www.tiktok.com/@${t}/video/${o.id}"]`);r&&addItem(o,r)}await getItem("Video:Sort by ER")?sortByER():sortByCreationTime(t)}},s.onerror=()=>{localStorage.setItem("timeout",2e4)},s.send(),clearInterval(interval),interval=setInterval(tiktokParse,+localStorage.getItem("timeout"))},interval=setInterval(tiktokParse,+localStorage.getItem("timeout"));let addItem=async(e,t)=>{if(t.getAttribute("data-ER"))return;await getItem("Video:Likes")?addLikes(t,e.stats.diggCount):Array.from(document.querySelectorAll("[data-video-like]")).map((e=>e?.parentNode.removeChild(e)));const a=document.createElement("strong");a.classList.add("jsx-1036923518"),a.classList.add("video-bottom-info"),t.querySelector(".jsx-1036923518.card-footer.normal.no-avatar").appendChild(a),await getItem("Video:Shares")?addShare(a,e):Array.from(document.querySelectorAll("[data-video-share]")).map((e=>e?.parentNode.removeChild(e))),await getItem("Video:Comments")?addComment(a,e):Array.from(document.querySelectorAll("[data-video-comment]")).map((e=>e?.parentNode.removeChild(e))),await getItem("Video:ER")?addER(t,e):Array.from(document.querySelectorAll("[data-video-ER]")).map((e=>e?.parentNode.removeChild(e))),t.classList.add("marked")},addLikes=(e,t)=>{const a=document.createElement("strong");a.classList.add("custom-like"),a.setAttribute("data-video-like",t);const o=document.createElement("strong");o.classList.add("jsx-1036923518"),o.classList.add("video-count"),o.innerText=t,o.setAttribute("data-video-like",t),e.querySelector(".jsx-1036923518 .video-bottom-info").appendChild(a),e.querySelector(".jsx-1036923518 .video-bottom-info").appendChild(o)},addShare=(e,t)=>{const a=document.createElement("svg");a.classList.add("custom-share"),a.setAttribute("data-video-share",t.stats.shareCount);const o=document.createElement("strong");o.classList.add("jsx-1036923518"),o.classList.add("video-count"),o.innerText=t.stats.shareCount,o.setAttribute("data-video-share",t.stats.shareCount),e.appendChild(a),e.appendChild(o)},addComment=(e,t)=>{const a=document.createElement("strong");a.classList.add("custom-comment"),a.setAttribute("data-video-comment",t.stats.commentCount);const o=document.createElement("strong");o.classList.add("jsx-1036923518"),o.classList.add("video-count"),o.innerText=t.stats.commentCount,o.setAttribute("data-video-comment",t.stats.commentCount),e.appendChild(a),e.appendChild(o)},addER=(e,t)=>{const a=document.createElement("strong");a.classList.add("jsx-1036923518"),a.classList.add("video-bottom-info"),e.querySelector(".jsx-1036923518.card-footer.normal.no-avatar").appendChild(a);const o=document.createElement("svg");o.classList.add("jsx-1036923518"),o.classList.add("video-count"),o.textContent="ER",a.appendChild(o);const r=document.createElement("strong");r.classList.add("jsx-1036923518"),r.classList.add("video-count");const d=100*(t.stats.commentCount+t.stats.diggCount+t.stats.shareCount)/t.stats.playCount;r.innerText=d.toFixed(2)+"%",a.appendChild(r),e.setAttribute("data-ER",d),a.setAttribute("data-video-ER",d)},sortByCreationTime=e=>{const t=itemsDict[e].reduce(((e,t)=>({[t.id]:t.createTime,...e})),{});var a=Array.from(document.querySelectorAll(`a[href^="https://www.tiktok.com/${e}/video/"]`));(a=(a=a.sort(((e,a)=>t[+e.href.split("/")[e.href.split("/")-1]]>t[+a.href.split("/")[a.href.split("/")-1]]?-1:t[+e.href.split("/")[e.href.split("/")-1]]<t[+a.href.split("/")[a.href.split("/")-1]]?1:0))).map((e=>e.closest(".video-feed-item.three-column-item")))).forEach((e=>document.querySelector(".video-feed.compact").appendChild(e)))},sortByER=()=>{var e=Array.from(document.querySelectorAll("a[data-ER]"));(e=(e=e.sort(((e,t)=>+e.getAttribute("data-ER")>+t.getAttribute("data-ER")?-1:+e.getAttribute("data-ER")<+t.getAttribute("data-ER")?1:0))).map((e=>e.closest(".video-feed-item.three-column-item")))).forEach((e=>document.querySelector(".video-feed.compact").appendChild(e)))},convertNumberToString=e=>{let t="";return t=e>1e6?`${(e/1e6).toFixed(1)}M`:e>1e3?`${(e/1e3).toFixed(1)}K`:e,t},addAverageERPerVideo=(e,t,a)=>{const o=(itemsDict[e].reduce(((e,t)=>e+(e=>100*(e.stats.commentCount+e.stats.diggCount+e.stats.shareCount)/e.stats.playCount)(t)),0)/itemsDict[e].length).toFixed(2)+"%",r=document.querySelector(`.count-infos.${a}`);let d=document.querySelector(`div[${t}]`);d||(d=document.createElement("div"),d.classList.add("number"),r.appendChild(d)),d.setAttribute(`${t}`,o);let i=document.querySelector(`div[${t}]`);i||(i=document.createElement("strong"),i.title=`Avg.${t.split("data-avg-")[1]}`,d.appendChild(i)),i.textContent=o,i.setAttribute(`${t}`,o);const n=document.createElement("span");n.classList.add("unit"),n.textContent=`Avg.${t.split("data-avg-")[1]}`,d.appendChild(n)},addAverageVideoCountPerDay=(e,t,a)=>{const o=itemsDict[e].reduce(((e,t)=>e<t.createTime?e:t.createTime)),r=itemsDict[e].reduce(((e,t)=>e>t.createTime?e:t.createTime)),d=((new Date(1e3*r)-new Date(1e3*o))/(864e5*itemsDict[e].length)).toFixed(2),i=document.querySelector(`.count-infos.${a}`);let n=document.querySelector(`div[${t}]`);n||(n=document.createElement("div"),n.classList.add("number"),i.appendChild(n)),n.setAttribute(`${t}`,d);let s=document.querySelector(`div[${t}]`);s||(s=document.createElement("strong"),s.title=`Avg.${t.split("data-avg-")[1]}`,n.appendChild(s)),s.textContent=d,s.setAttribute(`${t}`,d);const c=document.createElement("span");c.classList.add("unit"),c.textContent=`Avg.${t.split("data-avg-")[1]}`,n.appendChild(c)},addAverageCreatedTimePerVideo=(e,t,a)=>{let o=itemsDict[e].reduce(((e,t)=>{const a=new Date(1e3*t.createTime);return a.setFullYear(2e3,1,1),e+a.getTime()}),0)/itemsDict[e].length;o=new Date(o).toLocaleTimeString();const r=document.querySelector(`.count-infos.${a}`);let d=document.querySelector(`div[${t}]`);d||(d=document.createElement("div"),d.classList.add("number"),r.appendChild(d)),d.setAttribute(`${t}`,o);let i=document.querySelector(`div[${t}]`);i||(i=document.createElement("strong"),i.title=`Avg.${t.split("data-avg-")[1]}`,d.appendChild(i)),i.textContent=o,i.setAttribute(`${t}`,o);const n=document.createElement("span");n.classList.add("unit"),n.textContent=`Avg.${t.split("data-avg-")[1]}`,d.appendChild(n)},addAverageCounterPerVideo=(e,t,a,o)=>{const r=(itemsDict[e].reduce(((e,t)=>e+t.stats[a]),0)/itemsDict[e].length).toFixed(1),d=document.querySelector(`.count-infos.${o}`);let i=document.querySelector(`div[${t}]`);i||(i=document.createElement("div"),i.classList.add("number"),d.appendChild(i)),i.setAttribute(`${t}`,convertNumberToString(r));let n=document.querySelector(`div[${t}]`);n||(n=document.createElement("strong"),n.title=`Avg.${t.split("data-avg-")[1]}`,i.appendChild(n)),n.textContent=convertNumberToString(r),n.setAttribute(`${t}`,convertNumberToString(r));const s=document.createElement("span");s.classList.add("unit"),s.textContent=`Avg.${t.split("data-avg-")[1]}`,i.appendChild(s)},addViewsCount=(e,t,a,o)=>{const r=itemsDict[e].reduce(((e,t)=>e+t.stats[a]),0),d=document.querySelector(`.count-infos.${o}`);let i=document.querySelector(`div[${t}]`);i||(i=document.createElement("div"),i.classList.add("number"),d.appendChild(i)),i.setAttribute(`${t}`,convertNumberToString(r));let n=document.querySelector(`div[${t}]`);n||(n=document.createElement("strong"),n.title=t.split("data-")[1],i.appendChild(n)),n.textContent=convertNumberToString(r),n.setAttribute(`${t}`,convertNumberToString(r));const s=document.createElement("span");s.classList.add("unit"),s.textContent=t.split("data-")[1],i.appendChild(s)},updateProfile=async e=>{var t;await getItem("Profile:Views")?addViewsCount(e,"data-Views","playCount","tt-analytic-1"):(t=document.querySelector("[data-Views]"))?.parentNode.removeChild(t),await getItem("Profile:Shares")?addViewsCount(e,"data-Shares","shareCount","tt-analytic-1"):(t=document.querySelector("[data-Shares]"))?.parentNode.removeChild(t),await getItem("Profile:Comments")?addViewsCount(e,"data-Comments","commentCount","tt-analytic-1"):(t=document.querySelector("[data-Comments]"))?.parentNode.removeChild(t),await getItem("Profile:Average views")?addAverageCounterPerVideo(e,"data-avg-Views","playCount","tt-analytic-2"):(t=document.querySelector("[data-avg-Views]"))?.parentNode.removeChild(t),await getItem("Profile:Average shares")?addAverageCounterPerVideo(e,"data-avg-Shares","shareCount","tt-analytic-2"):(t=document.querySelector("[data-avg-Shares]"))?.parentNode.removeChild(t),await getItem("Profile:Average comments")?addAverageCounterPerVideo(e,"data-avg-Comments","commentCount","tt-analytic-2"):(t=document.querySelector("[data-avg-Comments]"))?.parentNode.removeChild(t),await getItem("Profile:Average ER")?addAverageERPerVideo(e,"data-avg-ER","tt-analytic-2"):(t=document.querySelector("[data-avg-ER]"))?.parentNode.removeChild(t),await getItem("Profile:Average created time")?addAverageCreatedTimePerVideo(e,"data-avg-CreatedTime","tt-analytic-2"):(t=document.querySelector("[data-avg-CreatedTime]"))?.parentNode.removeChild(t),await getItem("Profile:Average videos per day")?addAverageVideoCountPerDay(e,"data-avg-VideosPerDay","tt-analytic-2"):(t=document.querySelector("[data-avg-VideosPerDay]"))?.parentNode.removeChild(t)};async function getItem(e){return chrome?.storage?new Promise((t=>{chrome.storage.sync.get(e,(a=>{t(a[e])}))})):localStorage.getItem(e)}async function setItem(e,t){return chrome?.storage?new Promise((a=>{chrome.storage.sync.set({[e]:t},(e=>{a(e),console.log(e)}))})):localStorage.setItem(e,t)}